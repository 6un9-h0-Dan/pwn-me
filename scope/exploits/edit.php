<?php
error_reporting(1);
ob_start();
session_start();
include '../config.php';
if(!$_SESSION['role']){
    header("Location: /scope/");
}
?>
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Template &middot; Bootstrap</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">

        <!-- Le styles -->
        <link href="/scope/static/css/bootstrap.min.css" rel="stylesheet">
        <link href="/scope/static/css/app.css" rel="stylesheet">
        <link href="/scope/static/css/bootstrap-responsive.min.css" rel="stylesheet">
        <style>
            #desc{
                width: 60%;
                height: 400px;
            }
            .jumbotron{
                text-align: left;
            }
            .jumbotron .btn{
                /*font-size: 100%;*/
                /*padding: 0px;*/
            }
        </style>
    </head>

    <body>

        <div class="container">

            <?php include '../includes/header.php'; ?>

            <!-- Jumbotron -->
            <div class="jumbotron">
                <?php
                $exploit_id = mysql_real_escape_string(htmlspecialchars($_GET['id']));
                $sql = "SELECT * FROM exploits WHERE id='$exploit_id'";
                $result = mysqli_fetch_assoc(mysqli_query($con, $sql));
                $author = $result['author'];
                $title = $result['title'];
                $description = $result['description'];
                $platform = $result['platform'];
                ?>
                <?php if ($_SESSION['msg']) print $_SESSION['msg']; ?>
                <form action="" method="POST" align="center">
                    <div class="control-group">
                        <label class="control-label" for="author">Author</label>
                        <div class="controls">
                            <input type="text" value="<?php echo $author; ?>"  name ="author" id="author" class="span4" required />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="title">Title</label>
                        <div class="controls">
                            <input type="text" value="<?php echo $title; ?>" name ="title" id="title" class="span4" required />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="platform">Platform</label>
                        <div class="controls">
                            <input type="text" value="<?php echo $platform; ?>" name ="platform" id="platform" class="span4" required />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="desc">Description</label>
                        <div class="controls">
                            <textarea id="desc" name="desc" required><?php echo $description; ?></textarea>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="controls">
                            <button type="submit" class="btn btn-primary btn-large" name="edit">Edit The Exploit</button>
                        </div>
                    </div>
                </form>

                <hr>
            </div>
            <div class="footer">
                <p>Welcome to Change your mind - Demo by <a href="http://ruinedsec.wordpress.com">ruined-sec</a> | <a href="https://www.twitter.com/lnxg33k">@lnxg33k</a>.</p>
            </div>

        </div> <!-- /container -->

        <!-- Le javascript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="/scope/static/js/jquery.js"></script>
        <script src="/scope/static/js/bootstrap.min.js"></script>
    </body>
</html>
<?php

function clean($data, $flags = ENT_QUOTES, $encoding = 'UTF-8') {
    $data = htmlspecialchars($data, $flags, $encoding);
    return mysql_real_escape_string($data);
}

if (isset($_POST['edit'])) {
    if ($_POST['author'] && $_POST['title'] && $_POST['desc'] && $_POST['platform']) {
        $author = clean($_POST['author']);
        $title = clean($_POST['title']);
        $description = clean($_POST['desc']);
        $platform = clean($_POST['platform']);
        $sql = "UPDATE exploits SET author='$author', title='$title', description='$description', platform='$platform' WHERE id='$exploit_id'";
        $query = mysqli_query($con, $sql);
        $referer = $_SERVER['HTTP_REFERER'];
        if ($query) {
            $_SESSION['msg'] = '<div class="alert alert-success fade in" align="center">
                    <button type="button" class="close" data-dismiss="alert">×</button>
                    <strong>Updated successfully.</strong>
                    </div>';
        } else {
            $_SESSION['msg'] = '<div class="alert alert-error fade in" align="center">
                    <button type="button" class="close" data-dismiss="alert">×</button>
                    <strong>Sorry!</strong> something went wrong.
                    </div>';
        }
        header("Location: $referer");
    }
} else {
    $_SESSION['msg'] = NULL;
}
?>
